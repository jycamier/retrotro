name: Terraform Provider Release

on:
  workflow_call:
    inputs:
      version:
        description: "Version to release"
        required: true
        type: string
      tag:
        description: "Git tag"
        required: true
        type: string
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release"
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    name: Build and Release
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: terraform-provider-retrotro
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: terraform-provider-retrotro/go.mod
          cache-dependency-path: terraform-provider-retrotro/go.sum

      - name: Import GPG key
        id: import_gpg
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.PASSPHRASE }}

      - name: Setup GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          install-only: true

      - name: Run GoReleaser
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GPG_FINGERPRINT: ${{ steps.import_gpg.outputs.fingerprint }}
        run: |
          goreleaser release --clean

      - name: Summary
        run: |
          echo "## Terraform Provider Released" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Provider:** \`registry.terraform.io/jycamier/retrotro\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ inputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Usage" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`hcl" >> $GITHUB_STEP_SUMMARY
          echo "terraform {" >> $GITHUB_STEP_SUMMARY
          echo "  required_providers {" >> $GITHUB_STEP_SUMMARY
          echo "    retrotro = {" >> $GITHUB_STEP_SUMMARY
          echo "      source  = \"jycamier/retrotro\"" >> $GITHUB_STEP_SUMMARY
          echo "      version = \"${{ inputs.version }}\"" >> $GITHUB_STEP_SUMMARY
          echo "    }" >> $GITHUB_STEP_SUMMARY
          echo "  }" >> $GITHUB_STEP_SUMMARY
          echo "}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
